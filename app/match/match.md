

## 撮合

### 基本概念

撮合是一个交易的核心，撮合维护一张订单薄，买卖双方的下的订单会加载到订单薄中，进行价格和数量的匹配。

订单薄：存储买卖双方的订单，计算深度，聚合每个价格档位有多少数量。

流动性：订单薄上的挂单

限价单：指定价格，进行买卖。

市价单：方向为卖，指定基础币的数量，方向为买，指定计价币的数量。

市价买单，从卖盘中价格低的档位开始吃单直到基础币的最小单位，或者吃到卖盘为空。卖盘有100U卖10个和110U卖10的订单,基础币为最小单位为0.1。如果我下一个买111U方向为买的订单，则我会成交1.1个，剩下的1U返还。
111u先花100u买一个，剩11u，在花10u从100u那档买0.1个，最后剩1u返还

市价单卖，从买盘从高往下吃。

taker：主动成交的一方。

maker：被动成交的一方。

张三下了一个订单100USDT买一个IKUN，在此之后李四下了个99USDT卖出一个IKUN的订单，撮合系统在订单薄中找到了张三的订单，此次撮合系统会以100USDT的价格撮合这笔成交。张三为maker为被动成交的一方，李四为taker为主动成交的一方。一般来说maker的手续费会比taker低很多，maker为交易所提供了流动性。**订单成交价格都是以maker为准**

计价币：USDT

基础币：IKUN



**撮合基于红黑树实现，基于内存的撮合，撮合系统不持久化订单，每次启动从订单系统重加载订单,暂时允许自己和自己撮合**



|                                                              | 状态                           | 张三可用USDT | 张三冻结USDT | 张三可用IKUN | 张三冻结IKUN | 李四可用USDT | 李四冻结USDT | 李四可用IKUN | 李四冻结IKUN |
| ------------------------------------------------------------ | ------------------------------ | ------------ | ------------ | ----------- | ----------- | ------------ | ------------ | ----------- | ----------- |
| 张三100U买入10IKUN <br />李四100U卖出10IKUN                    | 张三全部成交<br />李四全部成交 | -1000        | +1000 -1000  | +10         |             | +1000        |              | -10         | +10 -10     |
| 张三100U买入10IKUN  <br />李四100U卖出1IKUN                    | 张三部分成交<br />李四全部成交 | -100         | +1000 -100   | +1          |             | +100         |              | -1          | +1 -1       |
| 张三100U买入10IKUN  <br />李四99U卖出1IKUN                     | 张三部分成交<br />李四全部成交 | -100         | +1000 -100   | +1          |             | +100         |              | -1          | +1 -1       |
| 张三100U买入10IKUN ，李四110U卖出10IKUN                        | 张三未成交<br />张三未成交     | -1000        | +1000        |             |             |              |              | -10         | +10         |
| 张三111U下了一个市价买单<br /> 此时订单薄有100u卖10<br />的订单基础币最小单位为1 | 张三部分成交<br />李四部分成交 | -110         | +111 -111    |             |             | +110         |              | -1.1        | +10 -1.1    |
| 张三市价卖单10<br /> 此时订单薄有100u买10的卖单<br />        | 张三全部成交<br />李四全部成交 | +1000        |              | -10         | +10 -10     | -1000        | +1000 -1000  | +10         |             |
